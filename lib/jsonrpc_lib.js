import{base64_decode,base64_encode,htmlentities,var_export,xh,xmlrpc_client,xmlrpc_debug_log,xmlrpcerr,xmlrpcmsg,xmlrpcresp,xmlrpcstr,xmlrpcval}from"./xmlrpc_lib.js";function json_encode_entities(data){return data==undefined?"":data.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\u002F/g,"\\/").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\u0008/g,"\\b").replace(/\v/g,"\\v").replace(/\f/g,"\\f")}function json_parse_native(data){try{var out=JSON.parse(data);return xh.value=out,!0}catch(e){return!(xh.isf_reason="JSON parsing failed")}}function jsonrpc_parse_resp(data,return_jsvals=!1,use_native_parsing=!0){var d_error;if(xh.isf=0,xh.isf_reason="",use_native_parsing?json_parse_native(data):!(xh.isf_reason="non-native JSON parsing not yet implemented.")){if("object"==typeof xh.value&&xh.value.result!==undefined&&xh.value.error!==undefined&&xh.value.id!==undefined)return d_error=xh.value.error,xh.id=xh.value.id,null!=d_error?(xh.isf=1,"object"==typeof d_error&&d_error.faultCode!==undefined&&d_error.faultString!==undefined?(0==d_error.faultCode&&(d_error.faultCode=-1),xh.value=d_error):xh.value=return_jsvals?{faultCode:-1,faultString:var_export(xh.value.error)}:{faultCode:-1,faultString:serialize_jsonrpcval(jsonrpc_encode(xh.value.error))}):xh.value=return_jsvals?xh.value.result:jsonrpc_encode(xh.value.result),1;xh.isf_reason="JSON parsing did not return correct jsonrpc response object"}}function jsonrpc_client(path,server,port,method){this.no_multicall=!0,this.return_type="jsonrpcvals",this.init(path,server,port,method)}function jsonrpcmsg(meth,pars,id){this.id=null,this.params=[],this.content_type="application/json",id!==undefined&&(this.id=id),this.init(meth,pars)}function jsonrpcresp(val,fcode,fstr,valtyp){this.id=null,this.init(val,fcode,fstr,valtyp)}function jsonrpcval(val,type){this.init(val,type)}function jsonrpc_decode(jsonrpc_val,options=[]){switch(jsonrpc_val.kindOf()){case"scalar":return jsonrpc_val.scalarVal();case"array":for(var size=jsonrpc_val.arraySize(),arr=[],i=0;i<size;++i)arr[arr.length]=jsonrpc_decode(jsonrpc_val.arrayMem(i),options);return arr;case"struct":var obj,key;for(key in obj=options.decode_js_objs&&""!=jsonrpc_val._js_class?new jsonrpc_val._js_class:{},jsonrpc_val.me)obj[key]=jsonrpc_decode(jsonrpc_val.me[key],options);return obj;case"msg":for(var paramcount=jsonrpc_val.getNumParams(),arr=[],i=0;i<paramcount;++i)arr[arr.length]=jsonrpc_val(jsonrpc_val.getParam(i));return arr}}function jsonrpc_encode(js_val,options){switch(typeof js_val){case"string":var jsonrpc_val=new jsonrpcval(js_val,"string");break;case"number":var num=new Number(js_val);jsonrpc_val=num==parseInt(num)?new jsonrpcval(js_val,"int"):new jsonrpcval(js_val,"double");break;case"boolean":jsonrpc_val=new jsonrpcval(js_val,"boolean");break;case"object":if(null===js_val)jsonrpc_val=new jsonrpcval(null,"null");else if(js_val.toJsonRpcVal)jsonrpc_val=js_val.toJsonRpcVal();else if(js_val instanceof Array){for(var arr=[],i=0;i<js_val.length;++i)arr[arr.length]=jsonrpc_encode(js_val[i],options);jsonrpc_val=new jsonrpcval(arr,"array")}else{var attr,arr={};for(attr in js_val)"function"!=typeof js_val[attr]&&(arr[attr]=jsonrpc_encode(js_val[attr],options));jsonrpc_val=new jsonrpcval(arr,"struct")}break;default:jsonrpc_val=new jsonrpcval}return jsonrpc_val}function jsonrpc_decode_json(json_val,options){if(xh.reset={},json_parse_native(json_val)){if("object"==typeof xh.value){if(xh.value.result!==undefined&&xh.value.error!==undefined&&xh.value.id!==undefined)return(r=null!=xh.value.error?("object"==typeof xh.value.error&&xh.value.error.faultCode!==undefined&&xh.value.error.faultString!==undefined?0==xh.value.error.faultCode&&(xh.value.error.faultCode=-1):xh.value={faultCode:-1,faultString:var_export(xh.value.error)},new jsonrpcresp(0,xh.value.faultCode,xh.value.faultString)):new jsonrpcresp(jsonrpc_encode(xh.value.result))).id=xh.value.id,r;if(xh.value.method!==undefined&&xh.value.params!==undefined&&xh.value.id!==undefined){for(var r=new jsonrpcmsg(xh.value.method,null,xh.value.id),i=0;i<xh.value.params.length;i++)r.addParam(jsonrpc_encode(xh.value.params[i]));return r}}return jsonrpc_encode(xh.value)}return xmlrpc_error_log(xh.isf_reason),!1}function serialize_jsonrpcval(value,charset_encoding){var num,rs="";switch(value.mytype){case 1:rs+='"'+json_encode_entities(value.me)+'"';break;case 4:isFinite(value.me)?rs+=value.me.toFixed():rs+="0";break;case 5:isFinite(value.me)&&null!==value.me?(rs+=value.me.toString(),(num=new Number(value.me))==parseInt(num)&&(rs+=".0")):rs+="0";break;case 6:rs+=value.me?"true":"false";break;case 7:rs+='"'+value.me+'"';break;case 8:rs+='"'+base64_encode(value.me)+'"';break;case 9:rs+="null";break;case 2:rs+="[";var len=value.me.length;if(len){for(var i=0;i<len-1;++i)rs=rs+serialize_jsonrpcval(value.me[i],charset_encoding)+",";rs+=serialize_jsonrpcval(value.me[i],charset_encoding)}rs+="]";break;case 3:for(var val in value.me)rs=(rs+=',"'+json_encode_entities(val)+'":')+serialize_jsonrpcval(value.me[val],charset_encoding);rs="{"+rs.slice(1)+"}"}return rs}jsonrpc_client.prototype=new xmlrpc_client,(jsonrpcmsg.prototype=new xmlrpcmsg).parseResponse=function(data,headers_processed=!1,return_type="jsonrpcvals"){var headers="";if("string"==typeof headers_processed&&(headers=headers_processed,headers_processed=!0),this.debug&&xmlrpc_debug_log("<PRE>---GOT---\n"+htmlentities(data)+"\n---END---\n</PRE>"),""==data)return xmlrpc_error_log("XML-RPC: jsonrpcmsg::parseResponse: no response received from server."),r=new jsonrpcresp(0,xmlrpcerr.no_data,xmlrpcstr.no_data);xh.reset={headers:[],cookies:[]};var raw_data=data;if(""!=headers)var r=this.parseResponseHeaders(headers,!0);else if("HTTP"==data.slice(0,4)){if("string"!=typeof(r=this.ParseResponseHeaders(data,headers_processed)))return r.raw_data=data,r;data=r}this.debug&&-1!=(headers=data.indexOf("/* SERVER DEBUG INFO (BASE64 ENCODED):"))&&(end=data.indexOf("*/",headers+=39),headers=data.slice(headers,end-1),xmlrpc_debug_log("<PRE>---SERVER DEBUG INFO (DECODED)---\n\t"+htmlentities(base64_decode(headers).replace(/\n/g,"\n\t"))+"\n---END---\n</PRE>"));var end=(data=data.replace(/^\s/,"").replace(/\s$/,"")).lastIndexOf("}");return 0<=end&&(data=data.slice(0,end+17)),"json"==return_type?((r=new jsonrpcresp(data,0,"","json")).hdrs=xh.headers,r._cookies=xh.cookies,r.raw_data=raw_data):(jsonrpc_parse_resp(data,"jsvals"==return_type)?(headers=xh.value,this.debug&&(xmlrpc_debug_log("<PRE>---PARSED---\n"),xmlrpc_debug_log(var_export(headers)),xmlrpc_debug_log("\n---END---</PRE>")),(r=xh.isf?new jsonrpcresp(0,headers.faultCode,headers.faultString):new jsonrpcresp(headers,0,"",return_type)).id=xh.id):(this.debug,r=new jsonrpcresp(0,xmlrpcerr.invalid_return,xmlrpcstr.invalid_return+" "+xh.isf_reason)),r.hdrs=xh.headers,r._cookies=xh.cookies,r.raw_data=raw_data),r},jsonrpcmsg.prototype.createPayload=function(charset_encoding){this.payload='{\n"method": "'+json_encode_entities(this.methodname)+'",\n"params": [ ';for(var i=0;i<this.params.length;++i)this.payload+="\n  "+serialize_jsonrpcval(this.params[i],charset_encoding)+",";this.payload=this.payload.slice(0,-1)+'\n],\n"id": '+(null==this.id?"null":this.id)+"\n}\n"},(jsonrpcresp.prototype=new xmlrpcresp).serialize=function(charset_encoding){return this.payload=function(resp,id,charset_encoding){var result='{\n"id": '+(id==undefined?"null":id)+", ";resp.errno?result+='"error": { "faultCode": '+resp.errno+', "faultString": "'+json_encode_entities(resp.errstr)+'" }, "result": null':"object"==typeof resp.val&&resp.val instanceof xmlrpcval?result+='"error": null, "result": '+serialize_jsonrpcval(resp.val,charset_encoding):"string"==typeof resp.val&&"json"==resp.valtyp&&(result+='"error": null, "result": '+resp.val);return result+="\n}"}(this,this.id,charset_encoding),this.payload},(jsonrpcval.prototype=new xmlrpcval).serialize=function(charset_encoding){return serialize_jsonrpcval(this,charset_encoding)};export{jsonrpc_client,jsonrpcmsg,jsonrpcresp,jsonrpcval,jsonrpc_decode,jsonrpc_encode,jsonrpc_decode_json};
//# sourceMappingURL=jsonrpc_lib.js.map