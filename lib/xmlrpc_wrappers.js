import{xmlrpc_client,xmlrpc_error_log,var_export}from"./xmlrpc_lib.js";function xmlrpc_2_js_type(xmlrpctype){switch(xmlrpctype.toLowerCase()){case"base64":case"string":return"string";case"datetime.iso8601":return"Date";case"int":case"i4":return"integer";case"struct":return"object";case"array":return"array";case"double":return"number";case"undefined":return"mixed";default:return xmlrpctype.toLowerCase()}}function wrap_xmlrpc_method(client,methodname,extra_options={}){var signum=extra_options.signum!=undefined?parseInt(extra_options.signum):0,timeout=extra_options.timeout!=undefined?parseInt(extra_options.timeout):0,protocol=extra_options.protocol!=undefined?extra_options.protocol:"",newfuncname=extra_options.new_function_name!=undefined?extra_options.new_function_name:"",encode_js_objects=extra_options.encode_js_objs!=undefined&&Boolean(extra_options.encode_js_objs),decode_js_objects=extra_options.decode_js_objs!=undefined&&Boolean(extra_options.decode_js_objs),simple_client_copy=extra_options.simple_client_copy!=undefined?parseInt(extra_options.simple_client_copy):0,buildit=extra_options.return_source==undefined||!extra_options.return_source,prefix=extra_options.prefix!=undefined?extra_options.prefix:"xmlrpc",decode_fault,fault_response,decode_fault,fault_response,debug=(fault_response=extra_options.return_on_fault!=undefined?(decode_fault=!0,extra_options.return_on_fault):(decode_fault=!1,""),extra_options.debug!=undefined?extra_options.debug:0),msgclass=prefix+"msg",valclass=prefix+"val",decodefunc=prefix+"_decode",msg=new this[msgclass]("system.methodSignature"),response=(msg.addParam(new this[valclass](methodname)),client.setDebug(debug),client.send(msg,timeout,protocol)),msig,msig,mdesc,xmlrpcfuncname,xmlrpcfuncname,xmlrpcfuncname,results,func;return response.faultCode()?(xmlrpc_error_log("XML-RPC: could not retrieve method signature from remote server for method "+methodname),!1):(msig=response.value(),"jsvals"!=client.return_type&&(msig=this[decodefunc](msig)),!(msig instanceof Array)||msig.length<=signum?(xmlrpc_error_log("XML-RPC: could not retrieve method signature nr."+signum+" from remote server for method "+methodname),!1):(msig=msig[signum],mdesc="",buildit?xmlrpcfuncname="":(xmlrpcfuncname=""!=newfuncname?newfuncname:prefix+"_"+methodname.replace(/\./g,"_").replace(/[^a-zA-Z0-9_\x7f-\xff]/g,""),msg=new this[msgclass]("system.methodHelp"),msg.addParam(new this[valclass](methodname)),response=client.send(msg,timeout,protocol),response.faultCode()||(mdesc=response.value(),"jsvals"!=client.return_type&&(mdesc=mdesc.scalarVal()))),results=build_remote_method_wrapper_code(client,methodname,xmlrpcfuncname,msig,mdesc,timeout,protocol,simple_client_copy,prefix,decode_js_objects,encode_js_objects,decode_fault,fault_response),buildit?(func=!1,eval("func = "+results.source),func||(xmlrpc_error_log("XML-RPC: could not create function "+xmlrpcfuncname+" to wrap remote method "+methodname),!1)):(results["function"]=xmlrpcfuncname,results)))}function wrap_xmlrpc_server(client,extra_options={}){var methodfilter=extra_options.method_filter!=undefined?extra_options.method_filter:"",signum=extra_options.signum!=undefined?parseInt(extra_options.signum):0,timeout=extra_options.timeout!=undefined?parseInt(extra_options.timeout):0,protocol=extra_options.protocol!=undefined?extra_options.protocol:"",newclassname=extra_options.new_class_name!=undefined?extra_options.new_class_name:"",encode_js_objects=extra_options.encode_js_objs!=undefined&&Boolean(extra_options.encode_js_objs),decode_js_objects=extra_options.decode_js_objs!=undefined&&Boolena(extra_options.decode_js_objs),verbatim_client_copy=extra_options.simple_client_copy==undefined||!Boolean(extra_options.simple_client_copy),buildit=extra_options.return_source==undefined||!Boolean(extra_options.return_source),prefix=extra_options.prefix!=undefined?extra_options.prefix:"xmlrpc",msgclass=prefix+"msg",decodefunc=prefix+"_decode",msg=new this[msgclass]("system.listMethods"),response=client.send(msg,timeout,protocol);if(response.faultCode())xmlrpc_error_log("XML-RPC: could not retrieve method list from remote server");else{var mlist=response.value();if("jsvals"!=client.return_type&&(mlist=this[decodefunc](mlist)),mlist instanceof Array&&mlist.length){for(var xmlrpcclassname,xmlrpcclassname,source=(xmlrpcclassname=""!=newclassname?newclassname:prefix+"_"+client.server.replace(/\./g,"_").replace(/[^a-zA-Z0-9_\x7f-\xff]/g,"")+"_client","function "+xmlrpcclassname+"()\n{\nvar client;\n\n"),opts=(source+=build_client_wrapper_code(client,verbatim_client_copy,prefix),source+="this.client = client;\n\n",{simple_client_copy:2,return_source:!0,timeout:timeout,protocol:protocol,encode_js_objs:encode_js_objects,prefix:prefix,decode_js_objs:decode_js_objects}),i=0,func;i<mlist.length;i++){var mname=mlist[i],new_function_name,methodwrap;""!=methodfilter&&-1==mname.search(methodfilter)||(new_function_name=mname.replace(/\./,"_").replace(/[^a-zA-Z0-9_\x7f-\xff]/,""),opts.new_function_name=" ",methodwrap=wrap_xmlrpc_method(client,mname,opts),methodwrap?(buildit||(source+=methodwrap.docstring),source+="this."+new_function_name+" = "+methodwrap.source+"\n"):xmlrpc_error_log("XML-RPC: will not create class method to wrap remote method "+mname))}return source+="}\n",buildit?(func=!1,eval("func = "+source),func||(xmlrpc_error_log("XML-RPC: could not create class "+xmlrpcclassname+" to wrap remote server "+client.server),!1)):{"class":xmlrpcclassname,code:source,docstring:""}}xmlrpc_error_log("XML-RPC: could not retrieve meaningful method list from remote server")}return!1}function build_remote_method_wrapper_code(client,methodname,xmlrpcfuncname,msig,mdesc,timeout,protocol,client_copy_mode,prefix,decode_js_objects,encode_js_objects,decode_fault,fault_response){for(var innercode,ptype,this_,code="function "+xmlrpcfuncname+" (",plist=(this_=client_copy_mode<2?(innercode=build_client_wrapper_code(client,client_copy_mode,prefix),innercode+="if (debug != undefined) client.setDebug(debug);\n",""):(innercode="","this."),innercode+="var msg = new "+prefix+"msg('"+methodname.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"');\n",mdesc=""!=mdesc?"/**\n* "+mdesc.replace(/\*\//g,"* /")+"\n":"/**\nFunction "+xmlrpcfuncname+"\n",[]),pcount=msig.length,i=1;i<pcount;++i)plist[i-1]="p"+i,innercode=innercode+("i4"==(ptype=msig[i])||"int"==ptype||"boolean"==ptype||"double"==ptype||"string"==ptype||"base64"==ptype||"null"==ptype?"var p"+i+" = new "+prefix+"val(p"+i+", '"+ptype+"');\n":encode_js_objects?"var p"+i+" = "+prefix+"_encode(p"+i+", {'encode_js_objs': true};\n":"var p"+i+" = "+prefix+"_encode(p"+i+");\n")+"msg.addParam(p"+i+");\n",mdesc+="* @param "+xmlrpc_2_js_type(ptype)+" p"+i+"\n";return client_copy_mode<2&&(plist[i-1]="debug",mdesc+="* @param int debug when 1 (or 2) will enable debugging of the underlying "+prefix+" call (defaults to 0)\n"),plist=plist.join(", "),mdesc+="* @return "+xmlrpc_2_js_type(msig[0])+" (or an "+prefix+"resp obj instance if call fails)\n*/\n",innercode+="var res = "+this_+"client.send(msg, "+timeout+", '"+protocol+"');\n",this_=decode_fault?"string"!=typeof fault_response||-1==fault_response.indexOf("%faultCode%")&&-1==fault_response.indexOf("%faultString%")?var_export(fault_response,!0):"'"+fault_response.replace(/'/g,"\\'").replace(/\%faultCode\%/g,"' + res.faultCode() + '").replace(/\%faultString\%/g,"' + res.faultString() + '")+"'":"res",{source:code+plist+") {\n"+(innercode+=decode_js_objects?"if (res.faultCode()) return "+this_+"; else return "+prefix+"_decode(res.value(), {'decode_js_objs': true});":"if (res.faultCode()) return "+this_+"; else return "+prefix+"_decode(res.value());")+"\n}\n",docstring:mdesc}}function build_client_wrapper_code(client,verbatim_client_copy,prefix){var fld,code="client = new "+prefix+"_client('"+client.path.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"', '"+client.server.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"', "+parseInt(client.port)+");\n";if(verbatim_client_copy){for(fld in client)"debug"!=fld&&"return_type"!=fld&&"function"!=typeof client[fld]&&(code+="client."+fld+" = "+var_export(client[fld],!0)+";\n");code+="client.return_type = '"+prefix+"vals';\n"}return code}export{wrap_xmlrpc_method,wrap_xmlrpc_server,build_remote_method_wrapper_code};
//# sourceMappingURL=xmlrpc_wrappers.js.map